<div class="container-fluid mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Sales</h3>
    <button class="btn btn-primary" (click)="openCreateModal(saleModal)">
      New Sale
    </button>
  </div>

  <!-- SALES TABLE -->
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-secondary text-center">
        <tr>
          <th style="width:10%">Action</th>
          <th>Customer</th>
          <th>Date</th>
          <th>Details</th>
          <th>Total</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let s of sales">
          <!-- ACTION -->
          <td class="text-center">
            <div ngbDropdown class="d-inline-block">
              <button class="btn btn-sm btn-primary" ngbDropdownToggle>
                Action
              </button>

              <div ngbDropdownMenu>
                <button class="dropdown-item" (click)="openEditModal(s, saleModal)">
                  Update
                </button>

                <button class="dropdown-item text-danger" (click)="deleteSale(s)">
                  Delete
                </button>
              </div>
            </div>
          </td>


          <!-- CUSTOMER -->
          <td class="text-center">{{ s.customer }}</td>

          <!-- DATE -->
          <td class="text-center">
            {{ s.dateTime | date:'medium' }}
          </td>

          <!-- DETAILS -->
          <td>
            <table class="table table-sm table-bordered mb-0 text-center">
              <thead class="table-light">
                <tr>
                  <th>Warehouse</th>
                  <th>Product</th>
                  <th>Qty</th>
                  <th>Price</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let p of s.products">
                  <td>{{ p.warehouse }}</td>
                  <td>{{ p.product }}</td>
                  <td>{{ p.quantity }}</td>
                  <td>{{ p.price }}</td>
                  <td>{{ p.quantity * p.price }}</td>
                </tr>
              </tbody>
            </table>
          </td>

          <!-- SALE TOTAL -->
          <td class="text-center fw-bold">
            {{ getSaleTotal(s) }}
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- CREATE / UPDATE MODAL -->
<ng-template #saleModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">
      {{ isEditMode ? 'Update Sale' : 'New Sale' }}
    </h5>
    <button class="btn-close" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body">

    <div class="mb-3">
      <label>Customer</label>
      <input class="form-control" [(ngModel)]="newSale.customer" name="customer" required>
    </div>

    <div class="mb-3">
      <label>Date</label>
      <input type="datetime-local" class="form-control" [(ngModel)]="newSale.dateTime" name="dateTime" required>
    </div>

    <!-- PRODUCTS -->
    <table class="table table-bordered text-center">
      <thead class="table-secondary">
        <tr>
          <th>Warehouse</th>
          <th>Product</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Total</th>
          <th></th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let p of newSale.products; let i = index">
          <td>
            <!-- WAREHOUSE -->
            <select class="form-select" [(ngModel)]="p.warehouse" name="warehouse{{i}}" (change)="onWarehouseChange(i)">
              <option [ngValue]="null">Select Warehouse</option>
              <option *ngFor="let w of warehouses" [ngValue]="w">{{ w }}</option>
            </select>

           

          </td>

          <td>
             <!-- PRODUCT -->
            <select class="form-select" [(ngModel)]="p.product" name="product{{i}}" (change)="onProductChange(i)">
              <option [ngValue]="null">Select Product</option>
              <option *ngFor="let prod of getProducts(p.warehouse)" [ngValue]="prod.product">
                {{ prod.product }}
              </option>
            </select>
          </td>

          <td>
            <input type="number" class="form-control" [(ngModel)]="p.quantity" (input)="calculateTotal()">
          </td>

          <td>
            <input type="number" class="form-control" [(ngModel)]="p.price" (input)="calculateTotal()">
          </td>

          <td>{{ p.quantity * p.price }}</td>

          <td>
            <button class="btn btn-danger btn-sm" (click)="removeRow(i)" [disabled]="newSale.products.length === 1">
              x
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <button class="btn btn-secondary btn-sm" (click)="addRow()">
      Add Product
    </button>

    <div class="text-end mt-3">
      <h5>Grand Total: {{ newSale.grandTotal }}</h5>
    </div>
  </div>

  <div class="modal-footer">
    <button class="btn btn-secondary" (click)="modal.dismiss()">Cancel</button>
    <button class="btn btn-primary" [disabled]="!canSave()" (click)="saveSale(modal)">
      {{ isEditMode ? 'Update' : 'Save' }}
    </button>
  </div>
</ng-template>